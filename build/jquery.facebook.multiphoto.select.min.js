window.log=function(){log.history=log.history||[];log.history.push(arguments);this.console&&console.log(Array.prototype.slice.call(arguments))};
(function(b){var u=function(r,h){var c=b(r);c.append(b('<div id="jfmps-inner-header"><div id="jfmps-breadcrumb"><span id="jfmps-default-crumb">Albums</span><span id="jfmps-crumb-separator">&raquo;</span><span id="jfmps-photos-list-crumb"></span></div><a class="jfmps-meta" id="jfmps-num-selected" href="javascript:void(0);">Selected (<span id="jfmps-selected-count">0</span>)</a><a class="jfmps-meta" id="jfmps-clear-button" href="javascript:void(0);">Clear Selected Images</a></div><div id="jfmps-album-covers"></div><div id="jfmps-album-photos"></div><div id="jfmps-selected-container"><h3>Selected Photos</h3><div id="jfmps-selected-photos"></div></div>'));var m=
b("#jfmps-album-covers",c),i=b("#jfmps-album-photos",c),n=b("#jfmps-selected-photos",c),u=b("#jfmps-selected-count",c),o=b("#jfmps-photos-list-crumb",c),s=b("#jfmps-crumb-separator",c),p=b("#jfmps-clear-button",c),d={maxPhotosSelected:10,numColumns:4,imageSubmitButton:b("#jfmps-submit-button"),submitCallback:function(a){alert(a)},noAlbumImagesText:"You have no images in this album.",noAlbumsText:"You do not have any albums.",selectedImageCallback:null,debug:true},q,g,f=0,d=b.extend(true,d,h||{});
d.maxPhotosSelected==1&&(b("#jfmps-selected-container").hide(),b(".jfmps-meta").hide(),b("#jfmps-album-covers").css("width","100%"),b("#jfmps-album-photos").css("width","100%"));var A=function(a){d.debug&&log("FB API Response /me/albums:",a);if(a.data&&a.data.length>0){var a=a.data,b;q={};g={};o.hide();s.hide();i.hide();d.imageSubmitButton.bind("click",v);p.bind("click",t);for(b=0;b<a.length;b++)((b+1)%d.numColumns===1||d.numColumns===1)&&m.append('<div class="image-row" />'),z(a[b])}else c.append("<h2>"+
d.noAlbumsText+"</h2>")},z=function(a){var e=b('<div id="fb-albumcover-'+a.id+'" class="jfmps-albumcover" />');e.data("album_id",a.id);var d=b('<div class="jfmps-albumname" />').text(a.name),c=b('<img width="130" src="https://graph.facebook.com/'+a.id+"/picture?access_token="+FB.getAccessToken()+'&amp;type=small" />');e.append(c);e.append(d);e.bind("click",function(b){B(b,e,a.name)});b("div.image-row",m).last().append(e)},B=function(a,b,k){var c=b.data("album_id");o.empty().html("{album_name} [X]".replace("{album_name}",
k));q[c]===void 0?FB.api("/"+c+"/photos",function(a){d.debug&&log("FB API Response /"+c+"/photos:",a);q[c]=a.data;w(c)}):w(c)},w=function(a){var a=q[a],e;if(a.length>0)for(e=0;e<a.length;e++){(e+1)%d.numColumns===1&&i.append('<div class="image-row" />');var c=b('<div id="fb-albumimage-'+a[e].id+'" class="jfmps-albumimage" />');c.data("image_id",a[e].id);g[a[e].id]!==void 0&&c.addClass("selected");var f=b('<img src="https://graph.facebook.com/'+a[e].id+"/picture?access_token="+FB.getAccessToken()+
'&amp;type=album" />');c.append(f);b("div.image-row",i).last().append(c);C(c,a[e].images)}else i.append("<h2>"+d.noAlbumImagesText+"</h2>");o.bind("click",x).show();s.show();m.hide();i.show()},C=function(a,c){var k=a.data("image_id");a.bind("click",function(){if(g[k]===void 0){if(f<d.maxPhotosSelected){g[k]=c;f+=1;d.maxPhotosSelected===1&&v();a.addClass("selected");var i=b("img",a),j=a.data("image_id"),j=b('<li id="selected-'+j+'"/>'),h;b("ul",n).length<=0?(h=b("<ul/>"),n.append(h)):h=b("ul",n);i.clone().appendTo(j);
h.append(j);D(j);l();d.selectedImageCallback!==null&&d.selectedImageCallback()}}else a.removeClass("selected"),delete g[k],i=a.data("image_id"),j=b("ul",n).eq(0),b("li#selected-"+i,j).remove(),f-=1,l();y()})},D=function(a){var c=b('<span class="jfmps-selected-unselect"/>').html("[x] remove");c.hide();a.css("position","relative");c.bind("click",function(c){c.preventDefault();c.stopPropagation();c=a.attr("id").split("selected-")[1];d.debug&&log("deleted: "+c);b("#fb-albumimage-"+c).removeClass("selected");
delete g[c];a.remove();f-=1;l()});a.bind("mouseenter",function(){c.show()});a.bind("mouseleave",function(){c.hide()});a.append(c)},x=function(){i.empty().hide();o.unbind("click").hide();s.hide();m.show()},v=function(){if(f>0){var a=f>0?JSON.stringify(g):false;d.debug&&log(a);d.submitCallback&&d.submitCallback(a);t();x()}},t=function(){for(var a in g)g.hasOwnProperty(a)&&(delete g[a],b("#fb-albumimage-"+a,c).removeClass("selected"),b("li#selected-"+a,c).remove());f=0;l();p.hide()},y=function(){f>0?
(d.imageSubmitButton.show(),p.show()):(d.imageSubmitButton.hide(),p.hide())},l=function(){u.html(f+" / "+d.maxPhotosSelected);y()};d.numColumns<1?d.debug&&log("settings.numColumns must be greater than 0"):(l(),FB.api("/me/albums",A));return{clearSelectedImages:function(){t()},getSelectedImages:function(){f>0&&JSON.stringify(g)}}};b.fn.jfmps=function(r){return this.each(function(){var h=b(this),c;if(h.data("jfmps"))return h.data("jfmps");c=new u(this,r);h.data("jfmps",c);return this})}})(jQuery);
